# ProjectE KOL 알림 동작 요약

기준: `tracker.py`, `db.py`, `bot.py`, `config.py` (현재 코드 기준)

## 1) 한 줄 요약

- 같은 지갑이 같은 종목/같은 outcome을 **연속 매수**할 때는 `1회차 상세`, `5/10/20회차 요약`, 그 외는 무음이다.
- `매도`는 기존처럼 상세 알림이 계속 온다(중복 tx/소액 조건 제외).

## 2) KOL 행동 -> 내가 받는 리액션

### A. 첫 진입 매수 (같은 방향 연속 카운트 1회)
- 수신: 상세 알림 1건
- 포함 정보:
  - 지갑(주소, 별명, 메모)
  - 종목명
  - 방향(Yes/No, 매수/매도, 가격, 추정 shares, USDC 규모)
  - Polymarket 종목 링크
  - 해당 지갑 프로필 링크
  - PolygonScan tx 링크
  - (조건부) `추적하기` 버튼

### B. 같은 지갑이 같은 종목/같은 outcome 계속 추매
- 연속 2~4회: 무음
- 연속 5회: 요약 알림 1건
- 연속 6~9회: 무음
- 연속 10회: 요약 알림 1건
- 연속 11~19회: 무음
- 연속 20회: 요약 알림 1건

요약 알림 포맷:
- `동일 방향 추매 반복 감지`
- 지갑/종목/방향(예: YES 매수 연속 10회)/시장 링크/tx 링크

### C. 매도 발생
- 수신: 상세 알림(기존 포맷)
- 추매 압축 정책은 매수에만 적용된다.

### D. 방향 전환 발생
- 내부 연속 카운트는 같은 `(지갑, 종목키, outcome)`에서 `side`가 바뀌면 1부터 다시 시작한다.
- 예: YES 매수 연속 중 YES 매도가 나오면 streak 리셋.

### E. 같은 블록에서 거래가 여러 건 잡힘
- 상세 알림에 경고 문구가 추가될 수 있다.
  - `이 트레이더는 이번 블록에 많은 거래를 진행했습니다...`
- 요약(추매 milestone) 알림에는 이 경고 문구가 붙지 않는다.

### F. tx 중복
- 같은 `(tx_hash, address)`는 한 번만 보낸다.
- 이미 보낸 tx는 재전송하지 않는다.

## 3) 알림이 아예 안 오는 경우

- 등록되지 않은 지갑 주소 거래
- 거래 규모가 최소값 미만:
  - 기본 최소: `$100` (`PROJECTE_MIN_USDC_ALERT`)
  - 예외 주소 1개는 최소값 필터 면제 (`PROJECTE_MIN_USDC_EXEMPT`)
- `market_key`를 못 만든 경우(희귀 케이스)
- 추매 압축 구간(예: 2,3,4,6,7,8,9...)

## 4) "추적하기" 버튼 관련 리액션

- 상세 알림에서만 `추적하기` 버튼이 붙는다(시장 slug가 있을 때).
- 버튼을 누르면:
  - 해당 `(지갑, 종목, outcome, side)`가 추적 목록에 추가된다.
- 이후 같은 종목에서 동일 outcome 기준으로 side가 바뀌면:
  - 별도 경고 알림: `결과 전에 포지션 변경/청산 가능성`

## 5) 운영 명령어 리액션 (텔레그램 봇)

- `/add <address>`: 지갑 등록, 이어서 별명/메모 입력 플로우
- `/remove <address>`: 지갑 삭제
- `/list`: 등록 지갑 목록
- `/tracking`: 현재 추적 중 포지션 목록
- `/alias <address> <별명>`: 별명 수정
- `/note <address> <메모>`: 메모 수정
- `/help`: 명령어 안내

## 6) 참고: 카운트 기준 단위

- 연속 추매 카운트는 DB `directional_streaks` 테이블에 저장된다.
- 키 구조: `(address, market_key, outcome)` + 현재 `side`
- milestone은 현재 코드에서 고정값 `{5, 10, 20}`이다.
