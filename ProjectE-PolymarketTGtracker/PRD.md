# ProjectE-PolymarketTGtracker PRD

## 0. 용어 정리 (간단)
- PRD(Product Requirements Document): 제품이 **무엇을**, **왜**, **어떤 기능으로** 만들지에 대한 요구사항 문서
- 제품 기획서/비전 문서: “우리가 만들고 싶은 그림”에 더 가까운 문서

즉,
- **기획서(비전)** = 꿈/방향/스토리
- **PRD** = 기능/요건/스펙

---

## 1. 목표
- 텔레그램 봇에 등록된 지갑 주소가 폴리마켓에서 거래할 때 **실시간에 가깝게 알림**을 받는다.
- 등록된 지갑 목록을 텔레그램에서 관리한다.
- 알림은 **공지 채널**로만 발송한다.

## 2. 배경/문제
- 폴리마켓은 지갑별 공식 API가 없음.
- PolyKOLscan 기반 수집은 **누락 가능성**이 있어 신뢰도가 낮음.
- 온체인 이벤트 기반 감지가 더 정확하고 실시간성이 높음.

## 3. 범위
### 포함
- 텔레그램 봇 명령어: `/add`, `/remove`, `/list`, `/note`, `/help`
- 온체인 이벤트 감지 (Polygon, CTF Exchange)
- 10초 폴링 기준의 실시간 감지 (초기)
- 알림 전송 (주소/이벤트명/매수-매도/가격/수량/시간)
- 구독 링크 기반의 **읽기 전용 팔로우** (비공개 채널 초대 링크)

### 제외(초기)
- 다중 사용자별 커스텀 주소 목록
- 고급 필터(시장 카테고리/금액 기준)
- Web UI 관리 페이지

## 4. 사용자 플로우
1) 텔레그램에서 `/add 0x... 메모`로 지갑 등록
2) 서버는 지갑 리스트 저장
3) 10초 주기로 온체인 이벤트 조회
4) 매칭되는 지갑 발견 시 텔레그램 **공지 채널**로 알림 전송
5) `/list`로 등록 목록 확인, `/remove`로 삭제
6) 공유 링크로 들어온 사용자는 **읽기 전용으로 알림 구독**

## 5. 핵심 기능 요구사항
### 5.1 지갑 관리
- `/add <address>`: 지갑 등록
  - 등록 직후 **별명 입력을 묻는 프롬프트** 제공
  - 별명 입력 후 **메모 입력을 묻는 프롬프트** 제공
  - 사용자가 `no` 입력 시 해당 필드는 비워둠 (메모/별명 없음 안내 메시지)
- `/remove <address>`: 지갑 삭제
- `/list`: 등록 목록 표시 (메모 포함)
- `/note <address> <메모>`: 메모 수정
- `/alias <address> <별명>`: 별명 설정/수정

### 5.2 알림
- 신규 거래 발생 시 즉시 알림
- 알림 내용 최소 필드:
  - 지갑주소(별명 있으면 별명 표시)
  - 이벤트명(시장명)
  - 매수/매도
  - Yes/No 방향
  - 수량/가격
  - 시간(UTC/KST)
  - 폴리마켓 링크
- 예측 결과 **클레임(claim)** 알림은 제외

### 5.3 중복 방지
- 동일 거래 ID는 1회만 알림
- 폴링 중복/재시작에도 알림 중복 없음
- 실패 시 재시도: 최대 3회

## 6. 기술 설계(요약)
### 6.1 데이터 소스
- Polygon 온체인 이벤트 (CTF Exchange / CTF)
- 시장명 매핑: Polymarket Gamma API

### 6.2 감지 방식
- 폴링 주기: **10초** (초기)
- 방식: `eth_getLogs` 기반 이벤트 조회
- 필터: 등록된 지갑 주소만 매칭

### 6.3 저장소
- 지갑 목록 DB (SQLite)
- 알림 상태 DB (last_seen_block, sent_tx_ids 등)
  - 마지막 처리 블록/거래를 저장해 재시작 시 중복 알림 방지

#### wallets (추가 컬럼)
- address (PK)
- alias (별명)
- note (메모)
- created_at
- updated_at

### 6.4 알림 전송
- Telegram Bot API

## 7. 운영
- 서버: Alibaba ECS
- 경로: `/home/ecs-user/ProjectE-PolymarketTGtracker/`
- systemd 서비스 + 타이머
- 로그: `logs/`

## 8. 보안
- 텔레그램 봇 토큰은 `secrets/`에 저장 (권한 600)
- RPC 키는 환경변수/시크릿 파일로 관리

## 9. 성공 기준
- 지갑 등록 → 거래 발생 시 **10초 내 알림 도착** (초기 기준, 5~20초 변동 가능)
- 24시간 안정적으로 동작
- 중복 알림 없음
- 공유 링크로 들어온 사용자도 알림 수신 가능

## 10. 미정/결정 필요
- RPC 제공사 (추천: Ankr)
- 폴링 블록 범위 전략
- 시장명 매핑 캐시 방식
- 10초 → 7초/5초 단축 여부 (비용/안정성 모니터링 후 결정)
- 구독 링크/읽기 전용 구경용 접근 방식 (채널/그룹 vs 링크 토큰)
