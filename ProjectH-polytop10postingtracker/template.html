<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Polymarket Alpha Daily</title>
  <style>
    :root {
      --bg: #e9edf5;
      --text: #152747;
      --card: #ffffff;
      --line: #cfdaee;
      --brand: #0b63e5;
      --banner-bg: #fff5d6;
      --banner-text: #7a4b00;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: linear-gradient(180deg, #f6f8fc 0%, #ebf2ff 100%);
      color: var(--text);
      min-height: 100vh;
    }
    .container {
      width: min(1080px, 92vw);
      margin: 0 auto;
      padding: 22px 0 48px;
    }
    .header {
      margin-bottom: 18px;
    }
    .title {
      margin: 0;
      font-size: 30px;
      font-weight: 800;
      letter-spacing: -0.02em;
    }
    .meta {
      margin-top: 8px;
      color: #4f6488;
      font-size: 14px;
    }
    .banner {
      background: var(--banner-bg);
      color: var(--banner-text);
      border: 1px solid #f6da8c;
      border-radius: 12px;
      padding: 10px 14px;
      margin: 14px 0 16px;
      font-size: 14px;
      font-weight: 700;
    }
    .archive-row {
      display: flex;
      align-items: center;
      gap: 8px;
      overflow-x: auto;
      padding-bottom: 10px;
      margin-bottom: 10px;
    }
    .date-btn {
      border: 1px solid #bed1f4;
      background: #f4f8ff;
      color: #1752b3;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 700;
      padding: 8px 11px;
      cursor: pointer;
      white-space: nowrap;
    }
    .date-btn.active {
      background: #0b63e5;
      border-color: #0b63e5;
      color: #fff;
    }
    .date-meta {
      margin: 4px 0 12px;
      color: #59739e;
      font-size: 13px;
      font-weight: 600;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(1, minmax(0, 1fr));
      gap: 12px;
    }
    .card {
      position: relative;
      display: grid;
      grid-template-columns: 340px minmax(0, 1fr);
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 10px 28px rgba(16, 32, 64, 0.08);
    }
    .card.no-image {
      grid-template-columns: 1fr;
    }
    .card-body {
      padding: 14px;
    }
    .index-tag {
      display: inline-block;
      font-size: 13px;
      border: 1px solid #c8d7f5;
      color: #0f4ebf;
      background: #eef4ff;
      border-radius: 999px;
      padding: 5px 10px;
      margin-bottom: 8px;
      font-weight: 700;
    }
    .author {
      font-size: 13px;
      color: #58709a;
      margin-bottom: 8px;
      font-weight: 600;
    }
    .text-ko {
      margin: 0 0 6px;
      line-height: 1.5;
      font-size: 13px;
      white-space: pre-wrap;
      font-weight: 550;
    }
    .expand-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 8px 12px;
      border-radius: 10px;
      border: 1px solid #c6d6f4;
      background: #f4f8ff;
      color: #0d5bd7;
      text-decoration: none;
      font-size: 13px;
      font-weight: 700;
      margin: 0;
      cursor: pointer;
    }
    .actions {
      margin-top: 0;
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 8px 12px;
      border-radius: 10px;
      border: 1px solid #c6d6f4;
      color: #0d5bd7;
      text-decoration: none;
      font-size: 13px;
      font-weight: 700;
      background: #f4f8ff;
    }
    .images {
      position: relative;
      display: grid;
      background: #e8eef9;
      min-height: 100%;
    }
    .images img {
      width: 100%;
      height: 100%;
      min-height: 230px;
      max-height: 430px;
      object-fit: cover;
      border-radius: 0;
      border: 0;
    }
    .image-actions {
      position: absolute;
      right: 10px;
      bottom: 10px;
      z-index: 2;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .card.no-image .image-actions {
      position: static;
      padding: 10px 12px 0;
    }
    @media (max-width: 860px) {
      .title { font-size: 25px; }
      .card { grid-template-columns: 1fr; }
      .card-body { padding: 12px; }
      .text-ko { font-size: 13px; }
      .images img { min-height: 190px; max-height: 280px; }
      .image-actions {
        right: 8px;
        bottom: 8px;
      }
    }
  </style>
</head>
<body>
  <main class="container">
    <header class="header">
      <h1 class="title">Polymarket Alpha Daily</h1>
      <div class="meta">최근 24시간 Polymarket 알파 포스트 | 생성 시각: {{ generated_at }}</div>
      {% if banner_message %}
      <div class="banner">{{ banner_message }}</div>
      {% endif %}
    </header>

    <section class="archive-row" id="archiveRow"></section>
    <div class="date-meta" id="dateMeta"></div>
    <section class="grid" id="cardsContainer"></section>
    <template id="cardTemplate">
      <article class="card">
        <div class="images"></div>
        <div class="image-actions actions">
          <a class="btn" target="_blank" rel="noopener noreferrer">원문 보기 (X)</a>
          <button class="expand-btn" type="button" hidden>펼치기</button>
        </div>
        <div class="card-body">
          <span class="index-tag"></span>
          <div class="author"></div>
          <p class="text-ko"></p>
        </div>
      </article>
    </template>
    <script>
      const archiveData = {{ archive_data | tojson }};
      const selectedDateFromBuild = {{ selected_date | tojson }};
      const dateKeys = Object.keys(archiveData).sort().reverse();
      const archiveRow = document.getElementById("archiveRow");
      const cardsContainer = document.getElementById("cardsContainer");
      const dateMeta = document.getElementById("dateMeta");
      const cardTemplate = document.getElementById("cardTemplate");
      function decodeHtml(value) {
        const textarea = document.createElement("textarea");
        textarea.innerHTML = value || "";
        return textarea.value;
      }

      function renderCards(dateKey) {
        cardsContainer.innerHTML = "";
        const rows = archiveData[dateKey] || [];
        dateMeta.textContent = `${dateKey} 핫 트윗 아카이브 (${rows.length}개)`;

        if (!rows.length) {
          const empty = document.createElement("div");
          empty.className = "card";
          empty.innerHTML = '<div class="card-body">해당 날짜 데이터가 없습니다.</div>';
          cardsContainer.appendChild(empty);
          return;
        }

        rows.slice(0, 10).forEach((post, idx) => {
          const node = cardTemplate.content.firstElementChild.cloneNode(true);
          node.querySelector(".index-tag").textContent = `#${idx + 1}`;
          node.querySelector(".author").textContent = `@${post.author || "unknown"}`;
          const textEl = node.querySelector(".text-ko");
          const fullText = decodeHtml((post.text_ko || "").trim());
          const shortLimit = 3600;
          textEl.textContent = fullText;
          const expandBtn = node.querySelector(".expand-btn");
          if (fullText.length > shortLimit) {
            let expanded = false;
            textEl.textContent = `${fullText.slice(0, shortLimit)}...`;
            expandBtn.hidden = false;
            expandBtn.textContent = "펼치기";
            expandBtn.addEventListener("click", () => {
              expanded = !expanded;
              textEl.textContent = expanded ? fullText : `${fullText.slice(0, shortLimit)}...`;
              expandBtn.textContent = expanded ? "접기" : "펼치기";
            });
          } else {
            expandBtn.hidden = true;
          }
          const btn = node.querySelector(".btn");
          btn.href = post.url || "#";

          const imagesWrap = node.querySelector(".images");
          const images = Array.isArray(post.images) ? post.images : [];
          if (!images.length) {
            imagesWrap.style.display = "none";
            node.classList.add("no-image");
          }
          images.slice(0, 1).forEach((imgUrl) => {
            const img = document.createElement("img");
            img.loading = "lazy";
            img.src = imgUrl;
            img.alt = "tweet image";
            imagesWrap.appendChild(img);
          });

          cardsContainer.appendChild(node);
        });
      }

      function renderDateButtons(currentDate) {
        archiveRow.innerHTML = "";
        dateKeys.forEach((dateKey) => {
          const btn = document.createElement("button");
          btn.className = "date-btn" + (dateKey === currentDate ? " active" : "");
          btn.textContent = dateKey;
          btn.addEventListener("click", () => {
            document.querySelectorAll(".date-btn").forEach((el) => el.classList.remove("active"));
            btn.classList.add("active");
            renderCards(dateKey);
          });
          archiveRow.appendChild(btn);
        });
      }

      const initialDate = dateKeys.includes(selectedDateFromBuild) ? selectedDateFromBuild : (dateKeys[0] || "");
      renderDateButtons(initialDate);
      renderCards(initialDate);
    </script>
  </main>
</body>
</html>
