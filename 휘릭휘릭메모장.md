# 휘릭휘릭메모장 (pair 4,5 검증 순서)

## 1) 서버 접속
```bash
ssh -i ~/.ssh/keys/lightsail-default.pem ubuntu@43.203.122.192
```

## 2) 워커 로그 실시간 보기 (새 주문 성공/실패 확인)
```bash
tail -f /tmp/projectk-worker.log
```

## 3) 새 터미널에서 최근 실행 결과 확인
```bash
sqlite3 /tmp/projectk_local.db "select id,pair_id,status,fail_reason,datetime(created_at,'unixepoch','localtime') from executions order by id desc limit 10;"
```

## 4) pair 4,5 주문 상태만 확인
```bash
sqlite3 /tmp/projectk_local.db "select id,pair_id,status,blocked_reason,adjusted_notional_usdc,datetime(created_at,'unixepoch','localtime') from mirror_orders where pair_id in (4,5) order by id desc limit 20;"
```

## 5) pair 4,5 allowance 즉시 확인
```bash
cd ~/claudecode/ProjectK-polycopyman
set -a && source .env.runtime && set +a
python3 -c 'import os,json,urllib.request;rpc=os.environ["PROJECTK_RPC_URL"];usdc=os.environ["PROJECTK_USDC_TOKEN_ADDRESS"];w={4:"0x3bb43833144ca754e5dc25742a645f7ae8dae12c",5:"0xe4e2ee48ab5a4f81144d17ac612320d300b268cf"};s=["0x4bFb41d5B3570DeFd03C39a9A4D8dE6Bd8B8982E","0xC5d563A36AE78145C45a50134d48A1215220f80a"];call=lambda m,p: json.loads(urllib.request.urlopen(urllib.request.Request(rpc,data=json.dumps({"jsonrpc":"2.0","id":1,"method":m,"params":p}).encode(),headers={"Content-Type":"application/json"}),timeout=20).read().decode())["result"];al=lambda o,sp:int(call("eth_call",[{"to":usdc,"data":"0xdd62ed3e"+o.lower().replace("0x","").rjust(64,"0")+sp.lower().replace("0x","").rjust(64,"0")},"latest"]),16)/1e6;[print(f"pair={k} allowance1={al(v,s[0])} allowance2={al(v,s[1])}") for k,v in w.items()]'
```

## 판정
- 성공: executions에 `pair_id=4/5`가 `filled` 또는 `sent`로 찍힘
- 실패: 다시 `not enough balance / allowance` 나오면 signer/funder 매핑 재점검

## 비율복제 세팅 (신규)
```bash
# 서버 접속
ssh -i ~/.ssh/keys/lightsail-default.pem ubuntu@43.203.122.192
```

```bash
# 소스 지갑 총자산 기준값 입력 (예시: source_wallet_id=5 기준 120000 USDC)
sqlite3 /tmp/projectk_local.db "update source_wallets set source_portfolio_usdc=120000 where id=5;"
sqlite3 /tmp/projectk_local.db "select id,address,alias,source_portfolio_usdc from source_wallets order by id;"
```

```bash
# 워커 재시작 (새 코드 반영)
pkill -f "python3 -m worker.signal_worker" || true
cd ~/claudecode/ProjectK-polycopyman
set -a && source .env.runtime && set +a
nohup /usr/bin/python3 -m worker.signal_worker >/tmp/projectk-worker.log 2>&1 </dev/null &
```

```bash
# 로그 확인
tail -f /tmp/projectk-worker.log
```

## 1분 미체결 시 +0.1 재호가 적용 배포
```bash
ssh -i ~/.ssh/keys/lightsail-default.pem ubuntu@43.203.122.192
cd ~/claudecode/ProjectK-polycopyman
git pull --rebase
python3 -m compileall backend worker
pkill -f "python3 -m worker.signal_worker" || true
set -a && source .env.runtime && set +a
nohup /usr/bin/python3 -m worker.signal_worker >/tmp/projectk-worker.log 2>&1 </dev/null &
tail -f /tmp/projectk-worker.log
```
