# STX/stSTX 자동매매봇 실행설계 v2

작성일: 2026-02-19

## 1) 목표

- 내재가치 대비 시장괴리(`edge_pct`) 기반 자동매매 봇 MVP를 구현한다.
- 주문 상한 `$500` 정책을 고정 적용한다.
- 거래 이벤트마다 Telegram 알림을 보낸다.
- 손익은 반드시 `STX` 단위로 기록/전송한다.

## 2) 고정 파라미터 (합의 반영)

- `max_order_usd = 500`
- `entry_threshold_pct = 0.8`
- `min_liquidity_usd = 200000`
- `execution_buffer_pct = 0.20`
- `max_daily_loss_pct = 2.0`
- `max_consecutive_losses = 5`
- `network_fee_cap_stx = 0.25`
- `min_fee_floor_stx = 0.001`

수수료 정책:
- `recommended_fee_stx = max(hiro_estimate_stx, min_fee_floor_stx)`
- `final_fee_stx = min(recommended_fee_stx * 1.2, network_fee_cap_stx)`

## 3) 시스템 구성

1. `data_collector`
- Hiro: 내재가치 계산용 온체인 값 수집
- Bitflow: 풀 유동성/시장가격 수집
- CoinGecko: 보조 가격 소스

2. `signal_engine`
- `edge_pct` 계산
- 진입/청산 신호 생성

3. `risk_manager`
- 일손실 제한
- 연속 손실 제한
- 이상 슬리피지/실패 시 kill-switch

4. `executor`
- 최종 quote 확인
- 수수료 계산
- 트랜잭션 실행
- `EXECUTOR_COMMAND` 외부 실행기로 서명/브로드캐스트 위임

5. `notifier`
- Telegram 이벤트 전송
- `trade_pnl_stx`, `running_pnl_stx` 포함

6. `storage`
- SQLite (MVP)
- 테이블: `signals`, `orders`, `fills`, `positions`, `pnl_daily`, `alerts`

## 4) 핵심 계산식

시장비율:
- `market_stx_per_ststx = ststx_usd / stx_usd`

내재가치:
- `intrinsic_stx_per_ststx = (reserve_total_stx - ststxbtc_supply - ststxbtc_v2_supply) / ststx_supply`

괴리:
- `edge_pct = (market_stx_per_ststx / intrinsic_stx_per_ststx - 1) * 100`

순엣지:
- `net_edge_pct = abs(edge_pct) - dex_fee_pct - slippage_pct - execution_buffer_pct`

진입:
- `abs(edge_pct) >= entry_threshold_pct`
- `net_edge_pct > 0`
- `liquidity_in_usd >= min_liquidity_usd`

STX 손익:
- `trade_pnl_stx = stx_received - stx_spent - fees_in_stx`
- `running_pnl_stx = Σ trade_pnl_stx`

## 5) 디렉터리 구조 (구현안)

```text
ProjectL -STX/stSTX/
  bot/
    app.py
    config.py
    data/
      hiro_client.py
      bitflow_client.py
      coingecko_client.py
    strategy/
      intrinsic.py
      signal.py
      slippage.py
    execution/
      fee_policy.py
      executor.py
    risk/
      guard.py
    notify/
      telegram_notifier.py
    storage/
      db.py
      schema.sql
    tests/
      test_signal.py
      test_fee_policy.py
      test_guard.py
```

## 6) 운영 플로우

1. 데이터 수집 (10~30초 주기)
2. `edge_pct` 계산
3. 리스크 체크
4. 진입 가능 시 실행
5. 체결/실패 알림 전송
6. 포지션 종료 시 `trade_pnl_stx` 확정
7. 일손실 한도 초과 시 자동 중지

## 7) API/시크릿

- 시크릿 저장:
  - `TG_BOT_TOKEN`, `TG_CHAT_ID`
  - 체결용 키(니모닉/프라이빗키는 코드/문서 금지)
- `.env` + 서버 시크릿 스토어 사용

## 8) 자동매매 위임 시 추가 필요사항

필수 준비물:
- 거래용 전용 지갑 1개 (일상 지갑과 분리)
- 운영 한도 자금 (초기 소액)
- Telegram 봇 토큰/채팅 ID
- 서버 접근 권한 (개인/회사 target 구분)
- 장애 대응 연락 채널 (최소 1개)

운영 합의값:
- 거래 상한: `$500`
- 일손실 한도: `2%`
- 연속 손실 제한: `5회`
- 타깃 미지정 배포 금지 (`company/personal` 필수)

## 9) 니모닉/개인키 전달 정책 (중요)

원칙:
- 니모닉/개인키는 **나에게 전달하지 않는다**.
- 채팅/깃/문서/코드 어디에도 평문으로 남기지 않는다.

허용 방식:
- 서버 내부 시크릿 스토어에 사용자 본인이 직접 주입
- 봇은 시크릿 값을 "읽기만" 하고 외부로 출력 금지

금지 방식:
- 채팅창에 니모닉 붙여넣기
- `.env`를 깃에 커밋
- 로그/알림에 키값 출력

권장 2안:
1. `ENV 직접 주입` (MVP)
- 서버에서 직접 설정: `TRADING_PRIVATE_KEY`, `TG_BOT_TOKEN` 등
- 파일 권한 `600`, 서비스 계정 단독 읽기

2. `원격 서명기` (확장)
- `signal/executor`와 `signer`를 분리
- signer는 내부망에서만 요청 수신
- 전략 프로세스는 키 원문 접근 불가

## 10) 시크릿 온보딩 절차 (실행 순서)

1. 거래 전용 지갑 생성
2. 소액만 입금
3. 서버에 시크릿 주입
4. dry-run에서 주문 미실행 검증
5. micro-live로 소액 체결 검증
6. 이상 없으면 점진 증액

검증 체크:
- 시크릿이 로그에 찍히지 않는지
- 프로세스 재시작 후 시크릿 로딩 정상인지
- Telegram 알림에 민감정보가 없는지

## 11) 역할 분리

- 사용자:
  - 지갑/시크릿 생성 및 보관
  - 자금 한도/리스크 승인
  - 배포 타깃 최종 결정

- 봇(코드):
  - 신호 계산
  - 리스크 체크
  - 실행/알림/기록

- 에이전트(나):
  - 코드 작성/검증/문서화
  - 시크릿 원문 비수집 원칙 준수

## 12) 즉시 구현 순서

1. `bot/config.py` + `.env.example`
2. `data` 3개 클라이언트
3. `strategy/signal.py` + `risk/guard.py`
4. `notify/telegram_notifier.py`
5. `storage/schema.sql` + `db.py`
6. `app.py` 루프 연결

## 13) 완료 기준 (MVP)

- 신호 생성 -> 실행 판단 -> 알림 전송까지 자동 동작
- 거래 이벤트마다 Telegram 메시지 도착
- 일별 `running_pnl_stx` 집계 확인
- 리스크 가드 3종 동작 확인

## 14) Executor I/O 프로토콜 (자동화용)

`app.py`는 `EXECUTOR_COMMAND`를 subprocess로 실행하고, stdin/stdout JSON으로 통신한다.

stdin(JSON):
- `action`
- `order_usd`
- `pool_id`
- `edge_pct`
- `slippage_pct`
- `fee_stx`

stdout(JSON):
- `ok` (bool)
- `status` (예: `filled`, `submitted`, `failed`)
- `reason` (string)
- `txid` (optional)
- `fee_stx` (optional)
- `filled_stx` (optional)
- `filled_ststx` (optional)
- `avg_fill_price_stx_per_ststx` (optional)
- `trade_pnl_stx` (optional)

참고:
- 스텁 구현: `bot/execution/external_executor_stub.py`
- 실서명기 미연결 시에도 `DRY_RUN=false` 경로를 안전하게 검증 가능

## 15) Real Executor (현재 구현 상태)

파일:
- `bot/execution/real_executor.py`

역할:
- bot에서 받은 stdin JSON을 signer API로 전달
- signer API 응답을 bot 표준 stdout JSON으로 변환

필수 환경변수:
- `SIGNER_API_URL` (예: `http://127.0.0.1:8787/sign-and-broadcast`)
- `SIGNER_API_TOKEN` (옵션)
- `SIGNER_TIMEOUT_SEC` (기본 20)

테스트용 mock signer:
- `bot/execution/mock_signer_server.py`
- 실제 체결 대신 `filled` 응답을 반환해 end-to-end 검증 가능

## 16) 리밸런싱 정책 (수익 보호형 확정안)

원칙:
- 강제 리밸런싱 금지
- 기대 순이익이 양수일 때만 리밸런싱 허용

트리거:
- 목표 비중: `STX 65% / stSTX 35%`
- 비중 이탈 허용: `±20%p`
- 체크 주기: `6시간`

실행 조건:
- `rebalance_net = expected_improvement_pct - fee_pct - slippage_pct - 0.15`
- `rebalance_net <= 0` 이면 실행 금지

주문 제약:
- 1회 주문: `$100 ~ $200`
- 하루 최대 실행: `2회`
- 분할 리밸런싱만 허용 (한 번에 목표 비중 강제 맞춤 금지)

목적:
- `0.5%`급 엣지를 리밸런싱 비용으로 잠식하지 않도록 보호
