# STX/stSTX 개발 로그 (2026-02-19)

## 목적
- 다음에 CLI를 다시 켰을 때, 오늘 어떤 문제를 겪었고 어떻게 해결했는지 빠르게 복구하기 위한 문서.
- 현재 운영 중인 자동매매 봇의 실제 동작 기준과 주의사항을 한 번에 확인.

## 오늘 구현된 핵심 기능
- 실거래 경로 구성 완료: `bot -> executor -> signer -> Hiro broadcast`.
- 텔레그램 알림 한글화 완료.
- 알림 포맷 개선 완료:
  - 주문접수(예상값)
  - `=======`
  - 실제 결과(온체인 확정값)
- 텔레그램 명령 `/status` 추가 완료.
- `/status`에서 STX, stSTX, 환산 STX, 총 STX 환산값 응답.

## 주요 이슈와 해결 로그

### 1) CoinGecko 429 (rate limit)로 주문 실패
- 증상:
  - `signer_http_error:500:http_429` 다수 발생.
- 원인:
  - 봇과 signer가 모두 CoinGecko를 별도 호출하면서 제한에 걸림.
- 조치:
  - 봇이 이미 가진 가격(`stx_usd`, `ststx_usd`)을 signer로 전달하도록 수정.
  - `real_executor.py`가 해당 필드를 signer로 넘기도록 수정.
  - 테스트용 fallback 가격 env(`STX_USD_FALLBACK`, `STSTX_USD_FALLBACK`) 지원.
- 결과:
  - 429 빈도 감소, 주문 경로 정상화.

### 2) signer 키 미주입으로 실거래 실패
- 증상:
  - `missing_signer_private_key`.
- 원인:
  - signer 프로세스 재시작 시 환경변수 `SIGNER_PRIVATE_KEY` 누락.
- 조치:
  - `~/.stx-bot-secrets/signer_private_key`에서 읽어 signer 실행하도록 고정.
- 결과:
  - 서명/브로드캐스트 단계 진입 가능.

### 3) 브로드캐스트 성공인데 실패로 기록되는 버그
- 증상:
  - 온체인에는 tx 성공, DB/알림은 실패로 표기.
- 원인:
  - signer의 broadcast 응답 파싱이 특정 응답 형태를 실패로 처리.
- 조치:
  - `signer/server.js`에서 broadcast 응답 파싱 보강.
- 결과:
  - `submitted`/`txid` 정상 기록.

### 4) 텔레그램 parse mode/문구 이슈
- 증상:
  - 일부 메시지 포맷 오류.
- 조치:
  - parse mode 처리 안정화.
  - 한글 라벨로 전면 전환.
- 결과:
  - 한국어 알림 안정 수신.

### 5) “예상 + 실제”를 한 메시지로 받고 싶음
- 요구사항:
  - 주문접수 후 별도 메시지가 아니라 하나의 메시지에 실제 결과까지 포함.
- 조치:
  - tx 폴링 로직 추가 (`HiroClient.wait_for_tx_outcome`).
  - 알림 payload 확장: 실제 체결수량/체결가/수수료/실현손익/상태/사유.
  - 텔레그램 렌더러에 `=======` + `실제 결과` 섹션 추가.
- 결과:
  - 단일 메시지로 예상/실제 비교 가능.

### 6) /status에서 stSTX가 0으로 나오는 버그
- 증상:
  - 지갑에 stSTX가 있는데 `/status`는 0으로 출력.
- 원인:
  - Hiro balances 토큰 키를 `::ststx-token`으로 잘못 읽음.
  - 실제 키는 `::ststx`.
- 조치:
  - `fetch_wallet_balances()` 키 매칭 로직 수정.
  - `::ststx` 우선 + fallback 검색으로 보강.
- 결과:
  - stSTX 수량 정상 반영.

## 내재가치(Conversion Rate) 기준 정리
- CoinGecko는 내재가치 API가 아님(시장가 데이터).
- 내재가치는 Hiro call-read + StackingDAO 컨트랙트 상태로 계산.
- 현재 사용 공식:
  - `stx_for_ststx = total_stx - ststxbtc_supply - ststxbtc_v2_supply`
  - `stx_per_ststx = stx_for_ststx / ststx_supply`
- 실제 조회값이 앱 화면 conversion rate와 일치 확인됨.

## 현재 운영 구조
- bot (Python): 신호판단/리스크/DB/알림.
- signer (Node): 실서명/브로드캐스트.
- Telegram:
  - 거래 알림
  - 명령 `/status`

## 오늘 기준 확인된 상태
- 실거래 제출/온체인 성공: 확인됨.
- 한글 알림: 정상.
- 예상+실제 단일 메시지: 정상.
- `/status` 잔고/환산: 정상.

## 다음 세션 시작 체크리스트
- 봇 프로세스 실행 여부 확인.
- signer 프로세스 실행 여부 확인.
- `/status`로 잔고/환산값 확인.
- 소액 1회 주문으로 알림/체결 파이프라인 점검.
