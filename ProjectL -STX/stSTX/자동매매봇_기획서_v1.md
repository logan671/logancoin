# STX/stSTX 자동매매 봇 기획서 v1

작성일: 2026-02-19  
범위: Bitflow 기반 STX/stSTX 내재가치 괴리 아비트라지 (소액-고빈도)

## 1) 보안 원칙 (최우선)

- 니모닉(Seed Phrase), 프라이빗키는 절대 공유하지 않는다.
- 봇 운영 시에도 니모닉을 코드/로그/문서에 저장하지 않는다.
- 키는 서버의 시크릿 스토어(환경변수 + 권한분리 + 암호화 파일)로만 관리한다.
- 추천 구조:
  - `signal-engine`(신호 계산)과 `signer-executor`(서명/체결)를 분리
  - signer 프로세스는 내부 네트워크에서만 접근 허용

## 2) 자금 배분 제안 (초기)

요청사항 반영:
- 운영 레벨(보수/중립/공격)로 고정하지 않음
- 이익 신호가 있을 때만 실행
- 1회 주문 상한은 `$500`

권장 운영값:
- `max_order_usd = 500`
- `position_sizing = dynamic` (신호 강도/유동성에 따라 100~500 달러 가변)
- `max_concurrent_positions = 2`

## 3) 전략 규칙 (MVP)

- 내재가치:
  - Hiro read-only로 `intrinsic_stx_per_ststx` 계산
- 시장가:
  - Bitflow ticker/quote로 `market_stx_per_ststx` 계산
- 신호:
  - `edge_pct = (market / intrinsic - 1) * 100`
- 진입 조건:
  - `abs(edge_pct) >= entry_threshold`
  - `expected_net_edge > 0`
- 청산 조건:
  - 목표 수익 도달
  - 시간 경과(예: 20~30분)
  - 반대 신호 전환

초기 파라미터(권장 시작점):
- `entry_threshold = 0.8%`
- `min_liquidity_usd = 200,000`
- `max_order_usd = 500`
- `cooldown_sec = 90`

## 4) 비용/리스크 모델

- 비용 항목:
  - DEX 수수료
  - 슬리피지(주문 크기 함수)
  - 네트워크/실패 트랜잭션 비용
- 순엣지 계산:
  - `net_edge = raw_edge - fee - slippage - execution_buffer`
- 실행 버퍼:
  - 시작은 최소 `0.20%` 고정 버퍼 권장
- 네트워크 수수료 정책(합의안):
  - `network_fee_cap_stx = 0.25`
  - `min_fee_floor_stx = 0.001`
  - 기본은 Hiro 추천 수수료 사용
  - 계산:
    - `recommended_fee_stx = max(hiro_estimate_stx, min_fee_floor_stx)`
    - `final_fee_stx = min(recommended_fee_stx * 1.2, network_fee_cap_stx)`

필수 보호장치(왜 필요한가):
- "이익 신호일 때만 진입" 규칙만으로는 부족함
- 이유: quote 지연, 체결 시점 가격변화, 슬리피지 급증, API stale/fallback 오차로 신호가 체결 순간 음수로 바뀔 수 있음
- 따라서 최소한 아래는 강제:
  - `max_daily_loss_pct` (기본 `2%`)
  - `max_consecutive_losses` (예: 5회)
  - `kill_switch` (연속 실패/이상 슬리피지 시 자동 중지)

## 5) 시스템 아키텍처

1. `market-data-worker`
- CoinGecko/Bitflow/Hiro 데이터 수집
- 10~30초 주기 캐시 갱신

2. `signal-engine`
- edge 계산, 진입/청산 판단
- 주문 제안 생성

3. `risk-manager`
- 최대 주문/일손실/동시포지션 제한
- kill-switch

4. `executor`
- quote 확인 -> 주문 생성 -> 서명 요청 -> 브로드캐스트

5. `monitoring`
- 체결률, 슬리피지, PnL, 실패율 대시보드
- 알림(Telegram/Slack)

6. `notifier`
- 거래 이벤트 발생 시 즉시 알림 전송
- 알림 채널: Telegram 우선 (추후 Slack/Discord 확장)
- 전송 트리거: `order_submitted`, `order_filled`, `order_failed`, `position_closed`

## 6) 서버 배포 계획

- 대상 서버: 기존 Ubuntu 서버
- 프로세스:
  - `bot-data.service`
  - `bot-signal.service`
  - `bot-exec.service`
- 공통:
  - 재시작 정책 `always`
  - 로그 로테이션
  - 헬스체크 엔드포인트 `/health`

## 7) 단계별 롤아웃

1. Dry-run (실주문 없음, 3~5일)
- 신호/가상체결/가상PnL 검증

2. Micro-live (소액 실주문, 5~7일)
- `$100~$300` 단위 체결 품질 확인

3. Controlled-live
- `$500~$1,000` 단계적 증액
- 손실 한도 엄수

## 8) 리뷰 포인트

- 내재가치 계산 주기(초 단위 vs 블록 단위)
- 주문 실패 시 재시도 정책
- 체결 전 재호가(quote refresh) 여부
- STX/stSTX 외 라우트(USDC 경유) 허용 여부
- 세금/회계 로깅 포맷
- `max_daily_loss_pct` 최종값 확정 (권장 `2%`, 최소한 1% 이상 권장)

## 9) 거래 알림 요구사항 (추가 반영)

요청사항:
- 거래가 실행될 때마다 알림
- 거래 내역 포함
- STX 기준 손익(몇 개 이득/손실) 표시

알림 필드(필수):
- `event_time` (UTC/KST)
- `action` (BUY/SELL)
- `pool_id`
- `order_size_usd`
- `filled_stx`
- `filled_ststx`
- `avg_fill_price`
- `fee_estimate`
- `slippage_estimate_pct`
- `realized_pnl_stx` (청산 시 확정)
- `running_pnl_stx` (누적)
- `txid` (체인 트랜잭션 링크 포함)

STX 손익 계산:
- 체결 단위 손익:
  - `trade_pnl_stx = stx_received - stx_spent - fees_in_stx`
- 누적 손익:
  - `running_pnl_stx = sum(trade_pnl_stx)`

알림 예시 포맷:
- `[FILLED] STX/stSTX BUY`
- `size: $500 | filled: 1,842.33 stSTX`
- `price: 0.2714 STX/stSTX | slip: 0.22%`
- `trade pnl: +3.91 STX | cumulative: +27.48 STX`
- `tx: <explorer_link>`

## 10) 다음 작업 제안

- v2 문서에서 아래 3개를 확정:
  1. 정확한 API 스펙(요청/응답 스키마)
  2. 리스크 파라미터 기본값
  3. 실제 배포용 서비스 유닛 파일(systemd)

## 11) Telegram 알림 스펙 (v2 초안)

### 환경변수

- `TG_BOT_TOKEN`: Telegram bot token
- `TG_CHAT_ID`: 수신 채팅 ID (개인/그룹)
- `TG_ENABLED`: `true/false`
- `TG_PARSE_MODE`: `Markdown` (기본)

### 이벤트 타입

- `order_submitted`
- `order_filled`
- `order_failed`
- `position_closed`
- `risk_alert`
- `daily_summary`

### 공통 JSON 스키마

```json
{
  "event_type": "order_filled",
  "event_time_utc": "2026-02-19T06:10:22Z",
  "strategy": "stx-ststx-arb-v1",
  "pool_id": "SM1793...stableswap-pool-stx-ststx-v-1-4",
  "txid": "0xabc123...",
  "side": "BUY",
  "order_size_usd": 500,
  "filled_stx": 432.18,
  "filled_ststx": 374.25,
  "avg_fill_price_stx_per_ststx": 1.1547,
  "fee_stx": 0.82,
  "slippage_pct": 0.21,
  "edge_pct_at_decision": 1.08,
  "trade_pnl_stx": 3.91,
  "running_pnl_stx": 27.48,
  "status": "filled",
  "reason": "edge>threshold and net_edge>0"
}
```

### 이벤트별 필수 필드

1. `order_submitted`
- `event_type`, `event_time_utc`, `pool_id`, `side`, `order_size_usd`, `edge_pct_at_decision`

2. `order_filled`
- `order_submitted` 필드 +
- `filled_stx`, `filled_ststx`, `avg_fill_price_stx_per_ststx`, `fee_stx`, `slippage_pct`

3. `order_failed`
- `event_type`, `event_time_utc`, `pool_id`, `side`, `order_size_usd`, `status`, `reason`

4. `position_closed`
- `event_type`, `event_time_utc`, `pool_id`, `trade_pnl_stx`, `running_pnl_stx`, `txid`

5. `risk_alert`
- `event_type`, `event_time_utc`, `status`, `reason`

6. `daily_summary`
- `event_type`, `event_time_utc`, `running_pnl_stx`, `trade_count`, `win_rate`, `max_drawdown_stx`

### Telegram 메시지 템플릿

```text
[FILLED] STX/stSTX BUY
time: 2026-02-19 15:10:22 KST
size: $500
fill: 374.25 stSTX / 432.18 STX
price: 1.1547 STX/stSTX
edge(decision): 1.08%
slippage: 0.21% | fee: 0.82 STX
trade pnl: +3.91 STX
cumulative pnl: +27.48 STX
tx: https://explorer.hiro.so/txid/0xabc123...?chain=mainnet
```

## 12) Notifier 모듈 인터페이스 (v2 초안)

### TypeScript 인터페이스

```ts
export type BotEventType =
  | 'order_submitted'
  | 'order_filled'
  | 'order_failed'
  | 'position_closed'
  | 'risk_alert'
  | 'daily_summary';

export interface BotEventPayload {
  event_type: BotEventType;
  event_time_utc: string;
  strategy: string;
  pool_id?: string;
  txid?: string;
  side?: 'BUY' | 'SELL';
  order_size_usd?: number;
  filled_stx?: number;
  filled_ststx?: number;
  avg_fill_price_stx_per_ststx?: number;
  fee_stx?: number;
  slippage_pct?: number;
  edge_pct_at_decision?: number;
  trade_pnl_stx?: number;
  running_pnl_stx?: number;
  status?: string;
  reason?: string;
  trade_count?: number;
  win_rate?: number;
  max_drawdown_stx?: number;
}

export interface Notifier {
  send(event: BotEventPayload): Promise<void>;
  sendBatch(events: BotEventPayload[]): Promise<void>;
  healthcheck(): Promise<boolean>;
}
```

### 동작 규칙

- 알림 실패 시 재시도: `3회`, 지수 백오프(1s, 2s, 4s)
- 같은 txid 중복 알림 방지: `dedupe_key = event_type + txid`
- 알림 큐는 비동기 처리, 트레이딩 실행 경로와 분리
