# 낙서장 (현재 구현 원리 정리)

## 1) 한 줄 요약
- 이 봇은 `STX/stSTX` 가격괴리를 보고 거래한다.
- 기준값은 CoinGecko가 아니라 `온체인 내재가치(Conversion Rate)`다.
- 거래 후 알림은 `예상값` + `실제 결과`를 한 메시지로 보낸다.

## 2) 데이터 소스
- 시장 가격
  - STX, stSTX USD 가격: CoinGecko
  - 풀/슬리피지 참고값: Bitflow
- 내재가치(핵심)
  - Hiro `call-read`로 StackingDAO 컨트랙트 상태를 읽어서 계산
  - 공식:
    - `stx_for_ststx = total_stx - ststxbtc_supply - ststxbtc_v2_supply`
    - `stx_per_ststx = stx_for_ststx / ststx_supply`
  - 실제 앱(`app.stackingdao.com`)의 conversion rate와 같은 계열 값

## 3) 매매 판단 로직
- 봇은 매 사이클마다 아래를 계산:
  - 시장가(`market_stx_per_ststx`)
  - 내재가치(`intrinsic_stx_per_ststx`)
  - 수수료/버퍼/슬리피지 반영 후 순엣지(`net_edge_pct`)
- 조건:
  - `net_edge_pct`가 진입 임계치보다 크면 진입
  - 아니면 HOLD(스킵)
- 리밸런싱:
  - 포트 비중 드리프트가 크면 리밸런싱 신호 생성
  - 기대 순이익이 0 이하이면 리밸런싱 금지

## 4) 주문 실행 구조
- `bot`은 실행기(`executor`)를 호출
- 실행기는 로컬 `signer` 서비스로 주문 payload 전달
- signer가 실제 트랜잭션 서명/브로드캐스트 수행
- signer 개인키는 서버 파일(`~/.stx-bot-secrets/signer_private_key`)에서만 읽음

## 5) 알림 구조
- 주문 제출 직후:
  - `주문접수` 알림 전송
  - 예상손익(수수료 포함) 표시
- 이후 tx 확인:
  - 온체인 tx 결과를 폴링해서 실제 체결 데이터 추출
  - 같은 메시지 아래에
    - `=======`
    - `실제 결과`
    - 실제 체결수량/체결가/수수료/실현손익 표시

## 6) /status 명령 원리
- 텔레그램에서 `/status` 입력 시:
  - 트레이딩 주소의 `STX`, `stSTX` 잔고 조회
  - 현재 `stx_per_ststx`로 `stSTX -> STX` 환산
  - `총 STX 환산` 계산해서 답장
- 출력 항목:
  - STX 보유
  - stSTX 보유
  - 환산비율(1 stSTX = x STX)
  - stSTX 환산 STX
  - 총 STX 환산

## 7) 손익 숫자 해석
- `예상손익`: 신호 시점 모델값
- `실현손익`: 실제 tx 이벤트 기반 확정값
- 둘이 다른 이유:
  - 실제 체결가
  - 실제 수수료
  - 실제 체결수량 반영

## 8) 현재 상태(요약)
- 실거래 체결 동작: OK
- 텔레그램 한글 알림: OK
- `/status` 잔고/환산 조회: OK
- stSTX 잔고 키 매칭 버그 수정 완료(`::ststx` 반영)
