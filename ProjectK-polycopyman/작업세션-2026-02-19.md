# ProjectK 작업 세션 로그 (2026-02-19)

## 1) 세션 목적
- ProjectK 복제 트레이딩 시스템을 로컬/서버에서 실사용 가능한 형태로 안정화
- 텔레그램 등록 UX 개선
- 소스 지갑 체결 감지(watcher) 및 실행(worker) 연결 강화
- 대시보드/운영 문서 개선

---

## 2) 최종 상태 요약
- 서버 대시보드 외부 접속 가능: `http://43.203.122.192:8082`
- API/웹 연결 정상(연결 상태 정상, DB 일치 확인)
- 등록 페어 `bera11` 표시 정상
- 텔레그램 명령 확장: `/whereami`, `/site`, `/howto`, `/rmpairall`
- watcher 동작 및 동적 polling(5~10초) 적용
- 실행 결과 알림 확장(실패 + 성공 + blocked)
- 유령 응답(예산 문구 반복) 원인 분리 완료
  - 서버 봇 응답과 외부/타 런타임 응답 분리 식별 가능

---

## 3) 주요 문제와 원인/해결

### A. `/rmpairall` 했는데 웹에 더미 데이터가 남아 보임
- 원인: 봇/API/웹이 서로 다른 DB 경로를 볼 가능성
- 해결:
  - `service_runtime` 테이블/heartbeat 추가
  - API `GET /runtime/services` 추가
  - 웹에 DB 일치 상태 배지/경고 표시 추가

### B. watcher 없어서 실거래 자동 감지가 안 됨
- 원인: 초기 구성은 mock 신호 기반
- 해결:
  - `worker/source_watcher.py` 신규 추가
  - Polygon `OrderFilled` 로그 파싱 -> `trade_signals` 저장
  - topic0 `0x` prefix 오류 수정

### C. watcher 5초 polling 과부하 우려
- 원인: 고정 polling은 트래픽/RPC 상태에 취약
- 해결:
  - 동적 polling: 기본 5초, 오류/느린 tick 시 10초 백오프, 안정 시 복귀
  - 관련 env 추가

### D. 텔레그램에서 `/addpair` 중복 질문/꼬임
- 원인:
  - 다중 프로세스 응답
  - 재시작 시 stale update 재처리
  - wizard state 잔존
- 해결:
  - 단일 인스턴스 lock(`/tmp/projectk-register-bot.lock`)
  - 시작 시 backlog drain
  - 일반 명령 입력 시 wizard 자동 해제
  - wizard TTL(180초) 추가
  - `/whereami`에 `instance(host:pid)` 출력

### E. 웹 외부 접속 불가
- 원인: 클라우드 인바운드/바인딩 문제
- 해결:
  - `WEB_HOST/WEB_PORT` 설정 도입
  - `0.0.0.0:8082` 바인딩
  - Lightsail 8082(및 필요 시 8081) 인바운드 가이드 문서화

### F. 웹은 열리는데 “연결끊김”
- 원인: 웹(8082)은 열렸지만 API(8081) 외부 접근 불가
- 해결:
  - API `0.0.0.0:8081` 바인딩
  - Lightsail 8081 인바운드 허용

### G. `/howto` 응답 불안정 + 예산 문구 유령 응답
- 원인: 동일 토큰을 쓰는 다른 poller가 업데이트 선점
- 해결:
  - `/site`, `/whereami`에 instance 표시로 발신원 구분
  - 로그에 수신 명령 기록
  - 서버/로컬 유령 프로세스 정리 절차 문서화

---

## 4) 기능 변경 내역 (코드)

### 4-1. API/DB/런타임
- `backend/config.py`
  - watcher 동적 제어 env 추가
  - 웹 host/port 및 dashboard url env 추가
- `backend/repositories/runtime.py` (신규)
  - 서비스 heartbeat 저장/조회
- `backend/app.py`
  - startup/shutdown heartbeat 루프
  - `GET /runtime/services` 추가
- `schema.sql`, `migrations/v0__init.sql`
  - `service_runtime` 테이블/인덱스 추가

### 4-2. watcher/worker
- `worker/source_watcher.py`
  - 체결 로그 수집/신호 생성
  - 동적 polling(backoff/recovery)
- `worker/signal_worker.py`
  - 예산 부족 시 1주 fallback
  - filled 알림 + blocked 알림 추가

### 4-3. 텔레그램 봇
- `bot/register_bot.py`
  - 명령 확장: `/rmpairall`, `/whereami`, `/site`, `/howto`
  - addpair 대화형 중복 시작 방지
  - stale updates drain + wizard auto-clear + TTL
  - instance 표기/로그 추적 강화

### 4-4. 대시보드
- `web/index.html`
  - DB 일치 상태 표시
  - 등록 정책 안내 보강
  - 페어 목록에 `누적 거래량(USDC)` 컬럼 추가
- `web/server.py`
  - env 기반 host/port 바인딩
  - heartbeat 추가

### 4-5. 문서
- `ProjectK-polycopyman/낙서장.md`
  - 실제 운영 중 발생한 케이스별 복구 절차(복붙용) 대폭 확장

---

## 5) 커밋 로그 (핵심)
- `f5491f7` ProjectK: runtime DB visibility + adaptive watcher polling
- `cbe0db4` ProjectK: filled/blocked alerts + dashboard URL command
- `29bf4a7` stale update replay 방지 + wizard auto-clear
- `2165ac5` wizard TTL + instance marker
- `31458c1` `/site` instance 표기 + telegram update 로그 강화
- `54dcc29` 누적 거래량 컬럼 + `/howto`
- `1ac222c` `/howto` 상세화(SSH/니모닉 입력 단계)
- `0ffbb1e`~`5e96c6b` 낙서장 운영/복구 가이드 보강
- `82f80f2`~`946f08f` 유령 응답 추적 및 bot.app 진단 절차 추가
- `14aece5`, `468d06b` 외부 접속/연결끊김 복구 가이드 추가

---

## 6) 운영 체크리스트 (내일 확인용)
1. 서버 프로세스 확인
- `backend.main`, `bot.register_bot`, `worker.signal_worker`, `worker.source_watcher`, `web.server`
2. API 헬스
- `/health` 응답 확인
3. 대시보드
- 연결 상태/DB 일치 상태 정상
4. 텔레그램
- `/whereami`, `/site`, `/howto` 응답 정상
5. watcher/worker 로그
- watcher tick 지속
- filled/failed/blocked 알림 동작

---

## 7) 다음 개선 제안
- systemd 서비스로 5개 프로세스 정식 관리(재부팅 자동복구)
- API 8081 외부 공개 대신 reverse proxy/Nginx 구성
- Telegram bot 토큰 단일 운영 정책 문서화(다중 poller 재발 방지)
- `/howto`를 단계형(버튼/상태 기반)으로 고도화

