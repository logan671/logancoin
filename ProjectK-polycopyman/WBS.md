# ProjectK - WBS (Work Breakdown Structure)

## 0. 원칙
- PRD 기준으로 MVP 우선 구현
- 운영 파라미터 기본값:
  - 슬리피지 상한 `3%`
  - 연속 실패 허용 `3회`
  - 가스 부족 알림 `MATIC <= 0.5`
- 소스 3개 페어로 라이브 운영 후 확장

## 1. 프로젝트 세팅
### 1.1 리포 구조 설계
- 작업:
  - `backend/`, `worker/`, `web/`, `infra/`, `docs/` 구조 정의
  - 공통 설정 파일(.env.example, config schema) 작성
- 산출물:
  - 폴더 구조 문서
  - 환경변수 명세
- 완료 조건(DoD):
  - 신규 개발자가 문서만 보고 로컬 부팅 가능

### 1.2 기본 개발 환경
- 작업:
  - 의존성 관리 도구 확정
  - 로깅 포맷/레벨 표준화
  - 기본 헬스체크 엔드포인트 구성
- 산출물:
  - 실행 스크립트
  - 헬스체크 응답 확인
- DoD:
  - 로컬에서 앱/워커가 독립 실행됨

## 2. 데이터 계층
### 2.1 DB 스키마 설계
- 작업:
  - 테이블 정의: `source_wallets`, `follower_wallets`, `wallet_pairs`, `trade_signals`, `mirror_orders`, `executions`, `risk_events`, `balances`, `alerts`
  - 인덱스/유니크키 설계 (idempotency key 포함)
- 산출물:
  - `schema.sql` 또는 migration 파일
- DoD:
  - 스키마 적용 후 핵심 조회 쿼리 실행 가능

### 2.2 저장소 레이어 구현
- 작업:
  - 페어 CRUD
  - 주문/실행/리스크 로그 저장 API
  - 트랜잭션 경계 정리
- 산출물:
  - repository/service 코드
- DoD:
  - 단위테스트로 기본 CRUD 통과

## 3. 보안/키 관리
### 3.1 암호화 vault 구현
- 작업:
  - 니모닉/키 평문 저장 금지
  - 암호화 저장 + 마스터 패스프레이즈 복호화
  - 키 조회 감사 로그
- 산출물:
  - vault 모듈
  - 키 등록/조회 인터페이스
- DoD:
  - DB/파일 dump에서 평문 니모닉이 노출되지 않음

### 3.2 운영 보안 가드
- 작업:
  - 민감정보 마스킹 로깅
  - 비밀값 로테이션 절차 문서화
- 산출물:
  - 보안 운영 문서
- DoD:
  - 로그에 private data 미출력 확인

## 4. 신호 감지 파이프라인
### 4.1 소스 지갑 이벤트 수집기
- 작업:
  - 온체인 이벤트 폴링/구독
  - 소스 지갑 필터
  - 지연/누락 지표 수집
- 산출물:
  - signal ingestor worker
- DoD:
  - 소스 거래 발생 시 `trade_signals`에 기록

### 4.2 정규화/중복방지
- 작업:
  - 매수/매도/아웃컴/가격/수량 정규화
  - idempotency key 생성 및 중복 차단
- 산출물:
  - normalizer 모듈
- DoD:
  - 동일 tx 재처리 시 mirror 주문 1회만 생성

## 5. 주문 실행 엔진
### 5.1 사이징 엔진
- 작업:
  - 소스 대비 비율 복제 로직
  - `min_order_size` 보정
  - follower 예산(100~1000 USD) 제한 반영
- 산출물:
  - sizing 모듈
- DoD:
  - 입력 신호 대비 예상 주문금액 계산 테스트 통과

### 5.2 실행 어댑터
- 작업:
  - 주문 생성/전송/체결 조회
  - 실행 결과 코드 표준화
- 산출물:
  - executor adapter
- DoD:
  - 테스트 환경에서 주문 성공/실패 분기 검증

## 6. 리스크 가드
### 6.1 거래 전 가드
- 작업:
  - 슬리피지 상한 `3%` 검사
  - 잔고 부족 검사(USDC/MATIC)
  - 가스 부족 경고(`MATIC <= 0.5`)
- 산출물:
  - pre-trade risk checker
- DoD:
  - 조건 위반 시 주문이 차단되고 `risk_events` 기록

### 6.2 자동 중지 로직
- 작업:
  - 연속 실패 3회 카운터
  - RPC 연속 오류 카운터(임계값 파라미터화)
  - pair 상태를 `paused`로 변경
- 산출물:
  - circuit breaker 모듈
- DoD:
  - 임계 도달 시 자동 중지 + 알림 발송

## 7. 알림 시스템
### 7.1 텔레그램 알림
- 작업:
  - 실행 성공/실패 알림
  - 중지/재개/가스 부족/손실 사유 알림
  - tx hash 링크 포함
- 산출물:
  - notifier 모듈
- DoD:
  - 주요 이벤트별 알림 템플릿 검증

## 8. Web UI
### 8.1 MVP 대시보드
- 작업:
  - 페어 목록/상태/최근 이벤트
  - 지갑별 PnL 및 승률
  - 오류/리스크 타임라인
- 산출물:
  - web pages + API
- DoD:
  - 운영자가 웹에서 페어 상태와 수익 현황 확인 가능

### 8.2 페어 관리 UI
- 작업:
  - 소스/팔로워 지갑 등록
  - 페어 활성/중지 토글
- 산출물:
  - pair management UI
- DoD:
  - 수동 DB 수정 없이 운영 가능

## 9. 테스트/검증
### 9.1 테스트 전략
- 작업:
  - 단위테스트: 사이징/리스크/중복방지
  - 통합테스트: 신호->주문->알림 E2E
- 산출물:
  - 테스트 코드
- DoD:
  - 핵심 플로우 자동 테스트 통과

### 9.2 라이브 파일럿
- 작업:
  - 소스 3개 페어로 소액 라이브
  - 장애 시나리오 점검
- 산출물:
  - 파일럿 리포트
- DoD:
  - 1주 운영 기준 치명 장애 없이 지속

## 10. 배포/운영
### 10.1 배포 파이프라인
- 작업:
  - 서비스/워커 프로세스 분리 배포
  - 재시작 정책/로그 로테이션
- 산출물:
  - 배포 스크립트/운영 문서
- DoD:
  - 재배포 시 데이터 일관성 유지

### 10.2 운영 런북
- 작업:
  - 장애 대응 절차
  - 수동 복구/롤백 절차
  - 알림 기준표
- 산출물:
  - `RUNBOOK.md`
- DoD:
  - 운영자 온콜 대응 가능

## 11. 우선순위 로드맵
### Sprint 1 (기반)
- 1, 2, 3 완료

### Sprint 2 (핵심 엔진)
- 4, 5, 6 완료

### Sprint 3 (운영 가능화)
- 7, 8, 9 완료

### Sprint 4 (안정화)
- 10 완료 + 확장 준비(20~50 페어)

## 12. 즉시 확정 필요값
- RPC 연속 오류 임계값(예: 5회)
- 잔고 부족 임계값(USDC 최소 실행 잔고)
- PnL 계산 정책(실현/미실현 포함 범위)
