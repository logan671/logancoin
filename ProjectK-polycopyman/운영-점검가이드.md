# ProjectK 운영 점검 가이드

## not enough balance / allowance 오류 점검
- 이 명령어가 뭐 하는 건지:
  - 실패 주문의 실제 페어/지갑/실패 사유를 DB와 로그로 확인해서 원인을 확정한다.
- 지금 우리가 무슨 작업을 하고 있는 건지:
  - 텔레그램 실패 알림만 보고는 부족한 정보(잔고 부족 vs 승인 부족 vs 지갑 매핑 오류)를 분리하는 단계.

```bash
echo "[1] 최근 실행 실패 확인"
sqlite3 /tmp/projectk_local.db "select id,mirror_order_id,pair_id,follower_wallet_id,status,fail_reason,executed_notional_usdc,created_at from executions order by id desc limit 10;"

echo "[2] 문제 pair의 팔로워 지갑/키 확인 (예: pair_id=5)"
sqlite3 /tmp/projectk_local.db "select p.id as pair_id, f.id as follower_wallet_id, f.address as follower_address, f.key_ref, f.budget_usdc from wallet_pairs p join follower_wallets f on f.id=p.follower_wallet_id where p.id=5;"

echo "[3] 워커 로그에서 live 오류 원문 확인"
tail -n 150 /tmp/projectk-worker.log | grep -Ei "live_rpc_error|allowance|balance|failed|order_id|pair_id" || true
```

판정 방법:
1. `fail_reason`에 `not enough balance / allowance`면 거래소 거절(온체인/거래소 계정 상태 문제)
2. `[2]`의 `follower_address`가 내가 자금 넣은 지갑과 다르면 지갑 매핑 오류
3. `follower_address`가 맞는데 실패면:
- 지갑 USDC 부족
- Polymarket allowance(승인) 부족
- 미체결 주문으로 잔고 예약 상태

빠른 해결 체크:
1. 팔로워 지갑에 USDC + MATIC 충분히 충전
2. Polymarket에서 해당 팔로워 지갑으로 1회 수동 주문/취소를 해 승인(allowance) 생성
3. 기존 미체결 주문이 있으면 정리 후 재시도
